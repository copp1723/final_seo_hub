#!/usr/bin/env node

// Real-time webhook monitoring script
// Run this to monitor for incoming SEOWorks webhooks

console.log('🎯 SEOWorks Webhook Activity Monitor')
console.log('=====================================\n')

// Check current time
const now = new Date()
console.log('📅 Current Time:', now.toISOString())
console.log('🌍 Timezone:', Intl.DateTimeFormat().resolvedOptions().timeZone)
console.log('')

console.log('🔍 STEP-BY-STEP INVESTIGATION FOR "Acura of Columbus":')
console.log('')

console.log('1️⃣ IMMEDIATE CHECKS (run these commands on production):')
console.log('')
console.log('   Check recent requests:')
console.log('   psql $DATABASE_URL -c "SELECT r.id, r.title, r.type, r.status, r.\\"seoworksTaskId\\", r.\\"createdAt\\", u.email, d.name FROM requests r LEFT JOIN users u ON r.\\"userId\\" = u.id LEFT JOIN dealerships d ON r.\\"dealershipId\\" = d.id WHERE (d.id = \'dealer-acura-columbus\' OR d.name ILIKE \'%Acura%Columbus%\') AND r.\\"createdAt\\" >= NOW() - INTERVAL \'3 hours\' ORDER BY r.\\"createdAt\\" DESC LIMIT 10;"')
console.log('')

console.log('   Check orphaned tasks:')
console.log('   psql $DATABASE_URL -c "SELECT ot.id, ot.\\"externalId\\", ot.\\"clientId\\", ot.\\"eventType\\", ot.\\"taskType\\", ot.status, ot.\\"createdAt\\" FROM orphaned_tasks ot WHERE (ot.\\"clientId\\" ILIKE \'%acura%\' OR ot.\\"clientEmail\\" ILIKE \'%acura%\' OR ot.deliverables::text ILIKE \'%acura%\') AND ot.\\"createdAt\\" >= NOW() - INTERVAL \'3 hours\' ORDER BY ot.\\"createdAt\\" DESC LIMIT 10;"')
console.log('')

console.log('2️⃣ WEBHOOK ENDPOINT STATUS:')
console.log('')
console.log('   Test endpoint connectivity:')
console.log('   curl -X GET https://rylie-seo-hub.onrender.com/api/seoworks/webhook')
console.log('')
console.log('   Expected response: {"status": "ok", "message": "SEOWorks webhook endpoint is active"}')
console.log('')

console.log('3️⃣ ACURA OF COLUMBUS CONFIGURATION:')
console.log('')
console.log('   • Dealership ID: dealer-acura-columbus')
console.log('   • Website: https://www.acuracolumbus.com/')
console.log('   • GA4 Property ID: 284944578')
console.log('   • Expected clientId in webhooks: "dealer-acura-columbus"')
console.log('')

console.log('4️⃣ EXPECTED WEBHOOK DATA FORMAT:')
console.log('')
console.log('   POST https://rylie-seo-hub.onrender.com/api/seoworks/webhook')
console.log('   Headers: { "x-api-key": "SEOWORKS_WEBHOOK_SECRET" }')
console.log('   Body: {')
console.log('     "eventType": "task.completed",')
console.log('     "data": {')
console.log('       "externalId": "seoworks-task-123",')
console.log('       "clientId": "dealer-acura-columbus",')
console.log('       "taskType": "blog|page|gbp_post|improvement",')
console.log('       "status": "completed",')
console.log('       "completionDate": "2025-08-13T19:00:00Z",')
console.log('       "deliverables": [')
console.log('         {')
console.log('           "type": "blog",')
console.log('           "title": "Blog Title",')
console.log('           "url": "https://www.acuracolumbus.com/blog/..."')
console.log('         }')
console.log('       ]')
console.log('     }')
console.log('   }')
console.log('')

console.log('5️⃣ WHAT HAPPENS WHEN WEBHOOK IS RECEIVED:')
console.log('')
console.log('   ✅ If user/dealership found:')
console.log('   • Creates or updates request in database')
console.log('   • Increments usage counters (pages/blogs/gbpPosts/improvements)')
console.log('   • Sends completion email to user')
console.log('   • Returns 200 OK with requestId')
console.log('')
console.log('   ⚠️  If dealership not found:')
console.log('   • Creates entry in orphaned_tasks table')
console.log('   • Returns 200 OK with "stored_for_later_processing"')
console.log('   • Can be processed later when dealership is onboarded')
console.log('')

console.log('6️⃣ TROUBLESHOOTING CHECKLIST:')
console.log('')
console.log('   🔍 If no webhook received:')
console.log('   • Verify webhook URL in SEOWorks: https://rylie-seo-hub.onrender.com/api/seoworks/webhook')
console.log('   • Check API key configuration (SEOWORKS_WEBHOOK_SECRET)')
console.log('   • Verify rate limiting (100 req/min)')
console.log('   • Check application logs for errors')
console.log('')
console.log('   🔍 If webhook received but not processed:')
console.log('   • Check orphaned_tasks table')
console.log('   • Verify clientId mapping')
console.log('   • Check user/dealership associations')
console.log('   • Review webhook payload format')
console.log('')

console.log('7️⃣ LIVE MONITORING:')
console.log('')
console.log('   Monitor logs in real-time:')
console.log('   # On Render server:')
console.log('   tail -f /var/log/app.log | grep -i "seoworks\\|webhook\\|acura"')
console.log('')
console.log('   Check database changes:')
console.log('   watch -n 5 \'psql $DATABASE_URL -c "SELECT COUNT(*) as recent_requests FROM requests WHERE \\"createdAt\\" >= NOW() - INTERVAL \'1 hour\';"\'')
console.log('')

console.log('🎯 ACTION ITEMS:')
console.log('')
console.log('1. Run the database queries above to see if webhook was received')
console.log('2. Test webhook endpoint connectivity')
console.log('3. Check application logs for any errors')
console.log('4. If found in orphaned_tasks, run user onboarding process')
console.log('5. Verify SEOWorks webhook configuration matches expected format')
console.log('')

console.log('📞 EXPECTED OUTCOME:')
console.log('   If SEOWorks "pushed Acura of Columbus through again":')
console.log('   • Should see new/updated request in database')
console.log('   • User should receive email notification')
console.log('   • Completion counters should be incremented')
console.log('   • Request status should be updated')

console.log('\n🕒 Timestamp: ' + new Date().toISOString())