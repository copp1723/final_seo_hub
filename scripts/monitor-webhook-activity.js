#!/usr/bin/env node

// Real-time webhook monitoring script
// Run this to monitor for incoming SEOWorks webhooks

console.log('ðŸŽ¯ SEOWorks Webhook Activity Monitor')
console.log('=====================================\n')

// Check current time
const now = new Date()
console.log('ðŸ“… Current Time:', now.toISOString())
console.log('ðŸŒ Timezone:', Intl.DateTimeFormat().resolvedOptions().timeZone)
console.log('')

console.log('ðŸ” STEP-BY-STEP INVESTIGATION FOR "Acura of Columbus":')
console.log('')

console.log('1ï¸âƒ£ IMMEDIATE CHECKS (run these commands on production):')
console.log('')
console.log('   Check recent requests:')
console.log('   psql $DATABASE_URL -c "SELECT r.id, r.title, r.type, r.status, r.\\"seoworksTaskId\\", r.\\"createdAt\\", u.email, d.name FROM requests r LEFT JOIN users u ON r.\\"userId\\" = u.id LEFT JOIN dealerships d ON r.\\"dealershipId\\" = d.id WHERE (d.id = \'dealer-acura-columbus\' OR d.name ILIKE \'%Acura%Columbus%\') AND r.\\"createdAt\\" >= NOW() - INTERVAL \'3 hours\' ORDER BY r.\\"createdAt\\" DESC LIMIT 10;"')
console.log('')

console.log('   Check orphaned tasks:')
console.log('   psql $DATABASE_URL -c "SELECT ot.id, ot.\\"externalId\\", ot.\\"clientId\\", ot.\\"eventType\\", ot.\\"taskType\\", ot.status, ot.\\"createdAt\\" FROM orphaned_tasks ot WHERE (ot.\\"clientId\\" ILIKE \'%acura%\' OR ot.\\"clientEmail\\" ILIKE \'%acura%\' OR ot.deliverables::text ILIKE \'%acura%\') AND ot.\\"createdAt\\" >= NOW() - INTERVAL \'3 hours\' ORDER BY ot.\\"createdAt\\" DESC LIMIT 10;"')
console.log('')

console.log('2ï¸âƒ£ WEBHOOK ENDPOINT STATUS:')
console.log('')
console.log('   Test endpoint connectivity:')
console.log('   curl -X GET https://rylie-seo-hub.onrender.com/api/seoworks/webhook')
console.log('')
console.log('   Expected response: {"status": "ok", "message": "SEOWorks webhook endpoint is active"}')
console.log('')

console.log('3ï¸âƒ£ ACURA OF COLUMBUS CONFIGURATION:')
console.log('')
console.log('   â€¢ Dealership ID: dealer-acura-columbus')
console.log('   â€¢ Website: https://www.acuracolumbus.com/')
console.log('   â€¢ GA4 Property ID: 284944578')
console.log('   â€¢ Expected clientId in webhooks: "dealer-acura-columbus"')
console.log('')

console.log('4ï¸âƒ£ EXPECTED WEBHOOK DATA FORMAT:')
console.log('')
console.log('   POST https://rylie-seo-hub.onrender.com/api/seoworks/webhook')
console.log('   Headers: { "x-api-key": "SEOWORKS_WEBHOOK_SECRET" }')
console.log('   Body: {')
console.log('     "eventType": "task.completed",')
console.log('     "data": {')
console.log('       "externalId": "seoworks-task-123",')
console.log('       "clientId": "dealer-acura-columbus",')
console.log('       "taskType": "blog|page|gbp_post|improvement",')
console.log('       "status": "completed",')
console.log('       "completionDate": "2025-08-13T19:00:00Z",')
console.log('       "deliverables": [')
console.log('         {')
console.log('           "type": "blog",')
console.log('           "title": "Blog Title",')
console.log('           "url": "https://www.acuracolumbus.com/blog/..."')
console.log('         }')
console.log('       ]')
console.log('     }')
console.log('   }')
console.log('')

console.log('5ï¸âƒ£ WHAT HAPPENS WHEN WEBHOOK IS RECEIVED:')
console.log('')
console.log('   âœ… If user/dealership found:')
console.log('   â€¢ Creates or updates request in database')
console.log('   â€¢ Increments usage counters (pages/blogs/gbpPosts/improvements)')
console.log('   â€¢ Sends completion email to user')
console.log('   â€¢ Returns 200 OK with requestId')
console.log('')
console.log('   âš ï¸  If dealership not found:')
console.log('   â€¢ Creates entry in orphaned_tasks table')
console.log('   â€¢ Returns 200 OK with "stored_for_later_processing"')
console.log('   â€¢ Can be processed later when dealership is onboarded')
console.log('')

console.log('6ï¸âƒ£ TROUBLESHOOTING CHECKLIST:')
console.log('')
console.log('   ðŸ” If no webhook received:')
console.log('   â€¢ Verify webhook URL in SEOWorks: https://rylie-seo-hub.onrender.com/api/seoworks/webhook')
console.log('   â€¢ Check API key configuration (SEOWORKS_WEBHOOK_SECRET)')
console.log('   â€¢ Verify rate limiting (100 req/min)')
console.log('   â€¢ Check application logs for errors')
console.log('')
console.log('   ðŸ” If webhook received but not processed:')
console.log('   â€¢ Check orphaned_tasks table')
console.log('   â€¢ Verify clientId mapping')
console.log('   â€¢ Check user/dealership associations')
console.log('   â€¢ Review webhook payload format')
console.log('')

console.log('7ï¸âƒ£ LIVE MONITORING:')
console.log('')
console.log('   Monitor logs in real-time:')
console.log('   # On Render server:')
console.log('   tail -f /var/log/app.log | grep -i "seoworks\\|webhook\\|acura"')
console.log('')
console.log('   Check database changes:')
console.log('   watch -n 5 \'psql $DATABASE_URL -c "SELECT COUNT(*) as recent_requests FROM requests WHERE \\"createdAt\\" >= NOW() - INTERVAL \'1 hour\';"\'')
console.log('')

console.log('ðŸŽ¯ ACTION ITEMS:')
console.log('')
console.log('1. Run the database queries above to see if webhook was received')
console.log('2. Test webhook endpoint connectivity')
console.log('3. Check application logs for any errors')
console.log('4. If found in orphaned_tasks, run user onboarding process')
console.log('5. Verify SEOWorks webhook configuration matches expected format')
console.log('')

console.log('ðŸ“ž EXPECTED OUTCOME:')
console.log('   If SEOWorks "pushed Acura of Columbus through again":')
console.log('   â€¢ Should see new/updated request in database')
console.log('   â€¢ User should receive email notification')
console.log('   â€¢ Completion counters should be incremented')
console.log('   â€¢ Request status should be updated')

console.log('\nðŸ•’ Timestamp: ' + new Date().toISOString())